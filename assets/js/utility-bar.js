document.addEventListener('DOMContentLoaded', () => {
  /* ---------- DATA ---------- */

  /* 6 rotating cities; oblastId matches SVG ids in assets/svg/ukraine-map.svg */
  const cities = [
    { city: "Kyiv", temp: "3Â°C", weather: "â˜ï¸ Cloudy", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/kyiv.jpg", oblastId: "KyivCity" },
    { city: "Lviv", temp: "-1Â°C", weather: "â„ï¸ Snow", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/lviv.jpg", oblastId: "Lviv" },
    { city: "Kharkiv", temp: "0Â°C", weather: "ðŸŒ«ï¸ Fog", alert: "ðŸ”´ Critical", photo: "/assets/images/cities/kharkiv.jpg", oblastId: "Kharkiv" },
    { city: "Odesa", temp: "4Â°C", weather: "ðŸŒ§ï¸ Rain", alert: "ðŸŸ  High Risk", photo: "/assets/images/cities/odesa.jpg", oblastId: "Odessa" },
    { city: "Mykolaiv", temp: "2Â°C", weather: "â˜ï¸ Cloudy", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/mykolaiv.jpg", oblastId: "Mykolaiv" },
    { city: "Zaporizhzhia", temp: "1Â°C", weather: "ðŸŒ¤ï¸ Partly Cloudy", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/zaporizhzhia.jpg", oblastId: "Zaporizhia" }
  ];

  /* All 24 oblasts + Kyiv + Sevastopol/Crimea, grouped North / South / East / West. All oblasts in each region rotate. */
  const REGIONS = {
    north: {
      label: "North",
      oblastIds: ["Chernihiv", "Kiev", "KyivCity", "Poltava", "Sumu", "Zhytomyr"]
    },
    south: {
      label: "South",
      oblastIds: ["Crimea", "Kherson", "Mykolaiv", "Odessa", "SevastopolCity"]
    },
    east: {
      label: "East",
      oblastIds: ["Dnipropetrovsk", "Donetsk", "Kharkiv", "Luhansk", "Zaporizhia"]
    },
    west: {
      label: "West",
      oblastIds: ["Cherkasy", "Chernivtsi", "Ivano-Frankivsk", "Khmelnytskyi", "Kirovohrad", "Lviv", "Rivne", "Ternopil", "Vinnytsia", "Volyn", "Zakarpattia"]
    }
  };

  /* Ukrainian spelling for display (map IDs stay as in SVG: Kiev, Odessa, etc.) */
  const UKRAINIAN_DISPLAY_NAMES = {
    Kiev: 'Kyiv',
    Odessa: 'Odesa',
    Sumu: 'Sumy',
    Dnipropetrovsk: 'Dnipro',
    Zaporizhia: 'Zaporizhzhia'
  };

  function formatOblastName(oblastId) {
    if (!oblastId) return '';
    if (UKRAINIAN_DISPLAY_NAMES[oblastId]) return UKRAINIAN_DISPLAY_NAMES[oblastId];
    return oblastId.replace(/([A-Z])/g, ' $1').trim().replace(/^ /, '').replace(/City$/, '').trim();
  }

  /* Oblast id â†’ image path for key-feature tooltip (files in assets/images/oblasts/{slug}.jpg) */
  function oblastImagePath(oblastId) {
    if (!oblastId) return null;
    const slug = oblastId.replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, '');
    return '/assets/images/oblasts/' + slug + '.jpg';
  }

  /* Air raid map: real data from assets/data/ukraine-alerts.json (from alerts.com.ua API). Fallback: city.alert text. */
  let alertData = { last_update: null, regions: {} };

  /* Per-oblast weather: real data from assets/data/ukraine-weather.json (capital cities via fetch-weather.js). */
  let weatherData = { last_update: null, oblasti: {} };

  function getOblastAlertLevel(oblastId) {
    if (alertData.regions && oblastId in alertData.regions) {
      return alertData.regions[oblastId] ? 'critical' : 'none';
    }
    const city = cities.find(c => c.oblastId === oblastId);
    if (!city) return 'elevated';
    if (city.alert.indexOf('Critical') !== -1) return 'critical';
    if (city.alert.indexOf('High') !== -1) return 'high';
    if (city.alert.indexOf('Elevated') !== -1) return 'elevated';
    return 'none';
  }

  function applyAirraidColors() {
    const container = document.getElementById('utility-airraid-container');
    if (!container) return;
    container.querySelectorAll('a[id]').forEach(a => {
      const id = a.getAttribute('id') || '';
      const path = a.querySelector('path');
      if (!path) return;
      path.classList.remove('airraid-alert-none', 'airraid-alert-elevated', 'airraid-alert-high', 'airraid-alert-critical');
      path.classList.add('airraid-alert-' + getOblastAlertLevel(id));
    });
  }

  /* Daily autogenerated fact about Ukraine â€” one per day of year (index 0â€“365).
     Each fact has a dedicated external \"learn more\" URL. */
  const ukraineFacts = [
    {
      text: "Ukraine is home to the worldâ€™s deepest metro station (Arsenalna, Kyiv).",
      url: "https://en.wikipedia.org/wiki/Arsenalna_(Kyiv_Metro)"
    },
    {
      text: "Ukraine has seven UNESCO World Heritage sites, including Kyivâ€™s Saint-Sophia Cathedral.",
      url: "https://whc.unesco.org/en/statesparties/ua"
    },
    {
      text: "The Ukrainian language is one of the most widely spoken Slavic languages.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_language"
    },
    {
      text: "Ukraine is often called the â€œbreadbasket of Europeâ€ for its grain production.",
      url: "https://en.wikipedia.org/wiki/Agriculture_in_Ukraine"
    },
    {
      text: "Lvivâ€™s historic centre is a UNESCO World Heritage site.",
      url: "https://whc.unesco.org/en/list/865"
    },
    {
      text: "Ukraineâ€™s Carpathian Mountains are a key biodiversity hotspot.",
      url: "https://en.wikipedia.org/wiki/Carpathian_Mountains"
    },
    {
      text: "The country has a long tradition of folk embroidery, with regional patterns.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_embroidery"
    },
    {
      text: "Ukraineâ€™s constitution was adopted in 1996.",
      url: "https://en.wikipedia.org/wiki/Constitution_of_Ukraine"
    },
    {
      text: "Odesa is known for its architecture and the Potemkin Stairs.",
      url: "https://en.wikipedia.org/wiki/Odesa"
    },
    {
      text: "Ukrainian literature includes Taras Shevchenko and Lesya Ukrainka.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_literature"
    },
    {
      text: "Ukraine has a strong tradition of choral and bandura music.",
      url: "https://en.wikipedia.org/wiki/Bandura"
    },
    {
      text: "The Trypillian culture in Ukraine dates back over 6,000 years.",
      url: "https://en.wikipedia.org/wiki/Cucuteni%E2%80%93Trypillia_culture"
    },
    {
      text: "Ukraineâ€™s Dnipro River is one of the major rivers of Europe.",
      url: "https://en.wikipedia.org/wiki/Dnieper"
    },
    {
      text: "Kyivâ€™s Golden Gate is a historic gateway from the medieval city.",
      url: "https://en.wikipedia.org/wiki/Golden_Gate,_Kyiv"
    },
    {
      text: "Ukraine has contributed significantly to aerospace and IT industries.",
      url: "https://en.wikipedia.org/wiki/Space_program_of_Ukraine"
    },
    {
      text: "The pysanka (decorated egg) is a symbol of Ukrainian culture.",
      url: "https://en.wikipedia.org/wiki/Pysanka"
    },
    {
      text: "The country has 24 oblasts plus Kyiv and Sevastopol.",
      url: "https://en.wikipedia.org/wiki/Oblasts_of_Ukraine"
    },
    {
      text: "Ukrainian diaspora communities exist across the Americas and Europe.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_diaspora"
    },
    {
      text: "Ukraineâ€™s nature reserves protect rare species like the European bison.",
      url: "https://en.wikipedia.org/wiki/Nature_reserves_of_Ukraine"
    },
    {
      text: "The sunflower is an important national symbol.",
      url: "https://en.wikipedia.org/wiki/Sunflower#Symbolism"
    },
    {
      text: "Ukraineâ€™s IT sector has grown into a major export industry.",
      url: "https://en.wikipedia.org/wiki/Information_technology_in_Ukraine"
    },
    {
      text: "Traditional Ukrainian cuisine includes borscht, varenyky, and salo.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_cuisine"
    },
    {
      text: "Ukraineâ€™s flag combines blue (sky) and yellow (wheat).",
      url: "https://en.wikipedia.org/wiki/Flag_of_Ukraine"
    },
    {
      text: "The Hryvnia is Ukraineâ€™s currency.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_hryvnia"
    },
    {
      text: "Ukrainian civil society has shown remarkable resilience.",
      url: "https://en.wikipedia.org/wiki/Civil_society_in_Ukraine"
    },
    {
      text: "Ukraineâ€™s Black Sea coast has important ports and ecosystems.",
      url: "https://en.wikipedia.org/wiki/Black_Sea#Environmental_issues"
    },
    {
      text: "Ukrainian volunteers have been central to humanitarian response.",
      url: "https://en.wikipedia.org/wiki/Volunteer_battalions_in_Ukraine"
    },
    {
      text: "The countryâ€™s museums preserve art, history, and cultural heritage.",
      url: "https://en.wikipedia.org/wiki/List_of_museums_in_Ukraine"
    },
    {
      text: "Ukraineâ€™s healthcare and education systems have deep historical roots.",
      url: "https://en.wikipedia.org/wiki/Healthcare_in_Ukraine"
    },
    {
      text: "Ukrainian designers and craftspeople preserve traditional arts.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_art"
    },
    {
      text: "The countryâ€™s legal profession supports justice and accountability.",
      url: "https://en.wikipedia.org/wiki/Law_of_Ukraine"
    },
    {
      text: "Ukraineâ€™s women have been leaders in military, medicine, and civil society.",
      url: "https://en.wikipedia.org/wiki/Women_in_Ukraine"
    },
    {
      text: "Ukrainian musicians perform classical, folk, and contemporary music.",
      url: "https://en.wikipedia.org/wiki/Music_of_Ukraine"
    },
    {
      text: "The countryâ€™s architects plan reconstruction of cities and villages.",
      url: "https://en.wikipedia.org/wiki/Architecture_of_Ukraine"
    },
    {
      text: "Ukraineâ€™s teachers continue to educate in shelters and online.",
      url: "https://en.wikipedia.org/wiki/Education_in_Ukraine"
    },
    {
      text: "Ukrainian poets and writers reflect on identity and resistance.",
      url: "https://en.wikipedia.org/wiki/List_of_Ukrainian_writers"
    },
    {
      text: "The countryâ€™s engineers work on demining and reconstruction.",
      url: "https://en.wikipedia.org/wiki/Mine_action#Ukraine"
    },
    {
      text: "Ukraineâ€™s farmers have continued to plant and harvest under difficult conditions.",
      url: "https://en.wikipedia.org/wiki/Agriculture_in_Ukraine"
    },
    {
      text: "Ukrainian filmmakers document the war and recovery.",
      url: "https://en.wikipedia.org/wiki/Cinema_of_Ukraine"
    },
    {
      text: "The countryâ€™s psychologists support trauma recovery.",
      url: "https://en.wikipedia.org/wiki/Mental_health_in_Ukraine"
    },
    {
      text: "Ukraineâ€™s hospitals and clinics provide care under fire.",
      url: "https://en.wikipedia.org/wiki/Healthcare_in_Ukraine_during_the_Russo-Ukrainian_War"
    },
    {
      text: "Ukrainian translators bridge languages for aid and diplomacy.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_language#Use_worldwide"
    },
    {
      text: "The countryâ€™s mayors and local leaders coordinate recovery.",
      url: "https://en.wikipedia.org/wiki/Local_government_in_Ukraine"
    },
    {
      text: "Ukraineâ€™s culture of mutual aid strengthens communities.",
      url: "https://en.wikipedia.org/wiki/Euromaidan#Self-organization"
    },
    {
      text: "Ukrainian runners and cyclists raise funds for aid.",
      url: "https://savelife.in.ua/en/donate/"
    },
    {
      text: "The countryâ€™s firefighters and rescuers save lives daily.",
      url: "https://en.wikipedia.org/wiki/State_Emergency_Service_of_Ukraine"
    },
    {
      text: "Ukraineâ€™s youth have driven innovation and civic engagement.",
      url: "https://en.wikipedia.org/wiki/Youth_in_Ukraine"
    },
    {
      text: "Ukrainian artists document and respond to the war through art.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_art"
    },
    {
      text: "The countryâ€™s libraries and archives preserve written heritage.",
      url: "https://en.wikipedia.org/wiki/National_Library_of_Ukraine"
    },
    {
      text: "Ukraineâ€™s railways help evacuate people and deliver aid.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_Railways"
    },
    {
      text: "Ukrainian chefs and restaurants keep culinary traditions alive.",
      url: "https://en.wikipedia.org/wiki/Ukrainian_cuisine"
    },
    {
      text: "The countryâ€™s NGOs coordinate with international aid agencies.",
      url: "https://www.humanitarianresponse.info/en/operations/ukraine"
    }
  ];

  /* Humanitarian/aid Ukraine news: loaded from assets/data/ukraine-news.json (EN + UK, rotates). Fallback below. */
  const newsSnippetsFallback = [
    { title_en: "Local NGOs deliver heating equipment to families in Lviv oblast.", title_uk: "ÐœÑ–ÑÑ†ÐµÐ²Ñ– ÐÐ£Ðž Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽÑ‚ÑŒ Ð¾Ð¿Ð°Ð»ÑŽÐ²Ð°Ð»ÑŒÐ½Ðµ Ð¾Ð±Ð»Ð°Ð´Ð½Ð°Ð½Ð½Ñ ÑÑ–Ð¼'ÑÐ¼ Ñƒ Ð›ÑŒÐ²Ñ–Ð²ÑÑŒÐºÑ–Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ñ–.", url: "/programs/humanitarian", category: "humanitarian" },
    { title_en: "Ukrainian volunteers run community kitchens in Odesa.", title_uk: "Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÑ– Ð²Ð¾Ð»Ð¾Ð½Ñ‚ÐµÑ€Ð¸ Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð¾Ð²ÑƒÑŽÑ‚ÑŒ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÑŒÐºÑ– ÐºÑƒÑ…Ð½Ñ– Ð² ÐžÐ´ÐµÑÑ–.", url: "/programs/humanitarian", category: "civil-society" },
    { title_en: "Mental health support expands for displaced children in Kyiv region.", title_uk: "Ð Ð¾Ð·ÑˆÐ¸Ñ€ÑŽÑ”Ñ‚ÑŒÑÑ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ñ–Ñ‡Ð½Ð¾Ð³Ð¾ Ð·Ð´Ð¾Ñ€Ð¾Ð²'Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼Ñ–Ñ‰ÐµÐ½Ð¸Ñ… Ð´Ñ–Ñ‚ÐµÐ¹ Ñƒ ÐšÐ¸Ñ—Ð²ÑÑŒÐºÐ¾Ð¼Ñƒ Ñ€ÐµÐ³Ñ–Ð¾Ð½Ñ–.", url: "/programs/resilience", category: "humanitarian" }
  ];

  /* ---------- ELEMENTS ---------- */

  const rotationCta = document.getElementById('rotation-cta');
  const factOfDayEl = document.getElementById('fact-of-day');
  const newsSnippetEl = document.getElementById('news-snippet');
  const mapTooltip = document.getElementById('map-tooltip');
  const timeKyivEl = document.getElementById('time-kyiv');
  const timeBremertonEl = document.getElementById('time-bremerton');
  const mapContainer = document.getElementById('utility-map-container');
  let oblastEls = [];

  /* ---------- LIVE CLOCKS: Kyiv (Europe/Kyiv), Bremerton (America/Los_Angeles) ---------- */

  const timeOpts = { hour: '2-digit', minute: '2-digit', hour12: false };

  function updateClocks() {
    const now = new Date();
    const kyivTime = now.toLocaleTimeString('en-GB', { ...timeOpts, timeZone: 'Europe/Kyiv' });
    const bremertonTime = now.toLocaleTimeString('en-GB', { ...timeOpts, timeZone: 'America/Los_Angeles' });
    if (timeKyivEl) {
      timeKyivEl.textContent = kyivTime;
      timeKyivEl.setAttribute('datetime', now.toISOString());
    }
    if (timeBremertonEl) {
      timeBremertonEl.textContent = bremertonTime;
      timeBremertonEl.setAttribute('datetime', now.toISOString());
    }
  }

  updateClocks();
  setInterval(updateClocks, 1000);

  /* ---------- FOUR ROWS (North/South/East/West) + ALL OBLASTS ROTATE + MAP HIGHLIGHT ---------- */

  let northIndex = 0, southIndex = 0, eastIndex = 0, westIndex = 0;

  function setActiveOblasts(oblastIds) {
    oblastEls.forEach(o => {
      o.classList.remove('oblast-active');
      const path = o.querySelector('path');
      if (path) path.style.removeProperty('fill');
    });
    if (!Array.isArray(oblastIds)) oblastIds = [oblastIds];
    oblastIds.forEach(id => {
      const el = mapContainer && mapContainer.querySelector('[id="' + id.replace(/"/g, '\\"') + '"]');
      if (el) {
        el.classList.add('oblast-active');
        const path = el.querySelector('path');
        if (path) path.style.setProperty('fill', '#ffd700');
      }
    });
  }

  /** For a region, get the display object for the currently selected oblast (city data if we have it, else name + key-feature image + per-oblast or region weather). */
  function getDisplayForRegion(regionKey) {
    const r = REGIONS[regionKey];
    if (!r || !r.oblastIds.length) return null;
    const idx = { north: northIndex, south: southIndex, east: eastIndex, west: westIndex }[regionKey];
    const oblastId = r.oblastIds[idx % r.oblastIds.length];
    const city = cities.find(c => c.oblastId === oblastId);
    if (city) return { ...city, oblastId };
    const level = getOblastAlertLevel(oblastId);
    const alertText = level === 'critical' ? 'ðŸ”´ Critical' : level === 'high' ? 'ðŸŸ  High Risk' : level === 'elevated' ? 'ðŸŸ¡ Elevated Risk' : 'ðŸŸ¢ None';
    // Prefer real per-oblast weather from backend JSON (capital city of this oblast).
    const w = weatherData.oblasti && weatherData.oblasti[oblastId];
    const sampleCity = cities.find(c => r.oblastIds.includes(c.oblastId));
    const fallbackTemp = sampleCity ? sampleCity.temp : 'â€”';
    const fallbackWeather = sampleCity ? sampleCity.weather : 'â€”';
    const tempText =
      w && typeof w.tempC === 'number' ? `${Math.round(w.tempC)}Â°C` : fallbackTemp;
    const weatherText =
      w && w.weather ? w.weather : fallbackWeather;
    return {
      city: formatOblastName(oblastId),
      temp: tempText,
      weather: weatherText,
      alert: alertText,
      photo: oblastImagePath(oblastId) || '',
      oblastId
    };
  }

  function getCurrentOblastId(regionKey) {
    const d = getDisplayForRegion(regionKey);
    return d ? d.oblastId : null;
  }

  function updateRegionRows() {
    const regionKeys = ["north", "south", "east", "west"];
    regionKeys.forEach(regionKey => {
      const display = getDisplayForRegion(regionKey);
      const photoEl = document.querySelector(`.region-photo[data-region="${regionKey}"]`);
      const textEl = document.querySelector(`.region-text[data-region="${regionKey}"]`);
      if (photoEl && textEl) {
        if (display) {
          photoEl.src = display.photo || '';
          photoEl.alt = display.city + " photo";
          const temp = display.temp !== undefined ? display.temp : 'â€”';
          const weather = display.weather !== undefined ? display.weather : 'â€”';
          textEl.textContent = `${display.city} â€” ${temp} Â· ${weather} Â· ${display.alert}`;
          photoEl.closest('.utility-region').classList.remove('utility-region-empty');
          photoEl.onerror = function() { this.style.display = display.photo ? 'none' : ''; };
        } else {
          photoEl.removeAttribute('src');
          textEl.textContent = '';
          photoEl.closest('.utility-region').classList.add('utility-region-empty');
        }
      }
    });
    const ids = regionKeys.map(k => getCurrentOblastId(k)).filter(Boolean);
    if (oblastEls.length) setActiveOblasts(ids);
  }

  function rotateRegionCity() {
    const rn = REGIONS.north.oblastIds.length;
    const rs = REGIONS.south.oblastIds.length;
    const re = REGIONS.east.oblastIds.length;
    const rw = REGIONS.west.oblastIds.length;
    northIndex = (northIndex + 1) % Math.max(1, rn);
    southIndex = (southIndex + 1) % Math.max(1, rs);
    eastIndex = (eastIndex + 1) % Math.max(1, re);
    westIndex = (westIndex + 1) % Math.max(1, rw);
    updateRegionRows();
  }

  function findRegionByOblastId(oblastId) {
    for (const key of Object.keys(REGIONS)) {
      if (REGIONS[key].oblastIds.includes(oblastId)) return key;
    }
    return null;
  }

  function setRegionToOblast(regionKey, oblastId) {
    const r = REGIONS[regionKey];
    if (!r || !r.oblastIds.includes(oblastId)) return;
    const pos = r.oblastIds.indexOf(oblastId);
    if (regionKey === 'north') northIndex = pos;
    if (regionKey === 'south') southIndex = pos;
    if (regionKey === 'east') eastIndex = pos;
    if (regionKey === 'west') westIndex = pos;
    updateRegionRows();
  }

  /* ---------- CTA (single; optional rotation of link) ---------- */

  const ctaLinks = [
    { text: "How You Can Help Today", href: "/donate" },
    { text: "Donate to Humanitarian Aid", href: "/donate" },
    { text: "Support Legal Research", href: "/programs/legal-research" },
    { text: "Volunteer with WSUA", href: "/volunteer-apply" }
  ];
  let ctaIndex = 0;
  function rotateCta() {
    if (!rotationCta) return;
    const cta = ctaLinks[ctaIndex];
    rotationCta.textContent = cta.text;
    rotationCta.href = cta.href;
    ctaIndex = (ctaIndex + 1) % ctaLinks.length;
  }
  rotateCta();
  setInterval(rotateCta, 8000);

  /* ---------- DAILY FACT (autogenerated by day of year) ---------- */

  function getFactOfDay() {
    const start = new Date(new Date().getFullYear(), 0, 0);
    const now = new Date();
    const dayOfYear = Math.floor((now - start) / (1000 * 60 * 60 * 24));
    const index = dayOfYear % ukraineFacts.length;
    return ukraineFacts[index];
  }

  function renderFactOfDay() {
    if (!factOfDayEl) return;
    const fact = getFactOfDay();
    const safeText = escapeHtml(fact.text);
    const safeUrl = fact.url || 'https://war.ukraine.ua/';
    factOfDayEl.innerHTML = `<span class="fact-label">Fact of the day:</span> ${safeText} <a href="${safeUrl}" target="_blank" rel="noopener">Learn more â†’</a>`;
  }

  /* ---------- NEWS SNIPPET: fetch real feed, rotate EN â†” UK ---------- */

  let newsItems = [];
  let newsIndex = 0;
  let showUkrainian = false;

  function renderNewsSnippet() {
    if (!newsSnippetEl) return;
    if (newsItems.length === 0) {
      newsSnippetEl.innerHTML = `<span class="news-label">Ukraine:</span> <a href="/programs/humanitarian">Loading newsâ€¦</a>`;
      return;
    }
    const item = newsItems[newsIndex];
    const title = showUkrainian ? (item.title_uk || item.title_en) : (item.title_en || item.title_uk);
    const lang = showUkrainian ? 'uk' : 'en';
    newsSnippetEl.innerHTML = `<span class="news-label">Ukraine:</span> <a href="${item.url}" target="_blank" rel="noopener" hreflang="${lang}">${escapeHtml(title)}</a>`;
    showUkrainian = !showUkrainian;
    if (!showUkrainian) newsIndex = (newsIndex + 1) % newsItems.length;
  }

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  renderNewsSnippet();

  /* Air raid map: load real alert data (from scripts/fetch-alerts.js + alerts.com.ua API) */
  fetch('/assets/data/ukraine-alerts.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      if (data && typeof data.regions === 'object') {
        alertData = { last_update: data.last_update || null, regions: data.regions };
        applyAirraidColors();
        const el = document.getElementById('airraid-last-update');
        if (el && alertData.last_update) {
          try {
            const t = new Date(alertData.last_update);
            if (!isNaN(t.getTime())) el.textContent = 'Updated ' + t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } catch (_) {}
        }
      }
    })
    .catch(() => { /* use fallback getOblastAlertLevel from cities */ });

  /* Per-oblast weather: load temperatures/conditions for each oblast capital (from scripts/fetch-weather.js) */
  fetch('/assets/data/ukraine-weather.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      if (data && typeof data.oblasti === 'object') {
        weatherData = {
          last_update: data.last_update || null,
          oblasti: data.oblasti || {}
        };
        // Immediately refresh region rows so temps/weather reflect real data.
        updateRegionRows();
      }
    })
    .catch(() => { /* keep fallback weather from cities[] */ });

  fetch('/assets/data/ukraine-news.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      if (data && Array.isArray(data.items) && data.items.length > 0) {
        newsItems = data.items;
      } else {
        newsItems = newsSnippetsFallback;
      }
      renderNewsSnippet();
    })
    .catch(() => {
      newsItems = newsSnippetsFallback;
      renderNewsSnippet();
    })
    .finally(() => {
      setInterval(renderNewsSnippet, 8000);
    });

  /* ---------- MAP: load SVG from file and init click + tooltip ---------- */

  function initMap() {
    oblastEls = document.querySelectorAll('#utility-map-container .oblast');
    if (oblastEls.length) {
      oblastEls.forEach(oblast => {
        oblast.addEventListener('click', (e) => {
          const id = oblast.id || oblast.dataset.region;
          if (!id) return;
          e.preventDefault();
          const regionKey = findRegionByOblastId(id);
          if (regionKey) {
            setRegionToOblast(regionKey, id);
          } else {
            window.location.href = '/programs/humanitarian';
          }
        });

        oblast.addEventListener('mousemove', (e) => {
          const id = oblast.id || '';
          const name = oblast.dataset.name || id || "Ukraine Region";
          const imgPath = oblastImagePath(id);
          if (imgPath) {
            mapTooltip.innerHTML = '<img class="map-tooltip-img" src="' + escapeHtml(imgPath) + '" alt=""> <span class="map-tooltip-label">' + escapeHtml(name) + '</span>';
            mapTooltip.classList.add('map-tooltip-with-img');
            const img = mapTooltip.querySelector('.map-tooltip-img');
            if (img) img.onerror = function() { this.style.display = 'none'; };
          } else {
            mapTooltip.textContent = name;
            mapTooltip.classList.remove('map-tooltip-with-img');
          }
          mapTooltip.style.left = (e.clientX + 12) + "px";
          mapTooltip.style.top = (e.clientY + 12) + "px";
          mapTooltip.style.opacity = "1";
        });

        oblast.addEventListener('mouseleave', () => {
          mapTooltip.style.opacity = "0";
          mapTooltip.innerHTML = '';
        });
      });
    }
    updateRegionRows();
  }

  const airraidContainer = document.getElementById('utility-airraid-container');

  if (mapContainer) {
    function loadMapSvg(url) {
      return fetch(url).then(r => r.ok ? r.text() : Promise.reject(new Error('Map load failed')));
    }
    (loadMapSvg('/assets/svg/ukraine-map.svg').catch(() => loadMapSvg('assets/svg/ukraine-map.svg')))
      .then(svgText => {
        const wrap = document.createElement('div');
        wrap.innerHTML = svgText.trim();
        const svg = wrap.firstElementChild;
        if (svg) {
          svg.classList.add('ukraine-map');
          svg.setAttribute('aria-label', svg.getAttribute('aria-label') || 'Map of Ukraine');
          const placeholder = mapContainer.querySelector('.utility-map-placeholder');
          if (placeholder) placeholder.remove();
          mapContainer.insertBefore(svg, mapContainer.firstChild);
          /* CodePen map: each <a id="..."> is an oblast; add class oblast and data attributes */
          const links = mapContainer.querySelectorAll('#Ukraine a[id], #ukraineMap a[id]');
          links.forEach(a => {
            a.classList.add('oblast');
            a.removeAttribute('href');
            a.removeAttribute('target');
            const id = a.getAttribute('id') || '';
            a.setAttribute('data-region', id.replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, ''));
            a.setAttribute('data-name', formatOblastName(id) + ' Oblast');
          });
          initMap();

          /* Air raid map: clone same SVG, color regions by alert level (app-style) */
          if (airraidContainer) {
            const svgClone = svg.cloneNode(true);
            svgClone.classList.add('ukraine-map', 'airraid-map');
            svgClone.removeAttribute('id');
            const g = svgClone.querySelector('g');
            if (g) g.removeAttribute('id');
            const airraidPlaceholder = airraidContainer.querySelector('.utility-map-placeholder');
            if (airraidPlaceholder) airraidPlaceholder.remove();
            airraidContainer.insertBefore(svgClone, airraidContainer.firstChild);
            const airraidLinks = airraidContainer.querySelectorAll('a[id]');
            airraidLinks.forEach(a => {
              a.removeAttribute('href');
              a.removeAttribute('target');
              const id = a.getAttribute('id') || '';
              const level = getOblastAlertLevel(id);
              const path = a.querySelector('path');
              if (path) path.classList.add('airraid-alert-' + level);
            });
            /* Hide labels in air raid map */
            airraidContainer.querySelectorAll('.cityName, text').forEach(el => el.style.setProperty('display', 'none'));
            applyAirraidColors();
          }
        }
      })
      .catch(() => { /* leave placeholder visible */ });
  }

  /* ---------- MOBILE: collapse bar on scroll, tap to expand ---------- */

  const utilityWrapper = document.querySelector('.utility-header-wrapper');
  if (utilityWrapper) {
    function updateCollapsed() {
      const isMobile = window.innerWidth <= 768;
      const scrolled = window.scrollY > 80;
      if (isMobile && scrolled) {
        utilityWrapper.classList.add('utility-bar-collapsed');
      } else {
        utilityWrapper.classList.remove('utility-bar-collapsed');
      }
    }
    window.addEventListener('scroll', updateCollapsed, { passive: true });
    window.addEventListener('resize', updateCollapsed);
    updateCollapsed();

    utilityWrapper.addEventListener('click', (e) => {
      if (e.target.closest('a, button')) return; /* let links/buttons work */
      if (utilityWrapper.classList.contains('utility-bar-collapsed')) {
        utilityWrapper.classList.remove('utility-bar-collapsed');
      }
    });
  }

  /* ---------- INIT ---------- */

  updateRegionRows();
  renderFactOfDay();

  setInterval(rotateRegionCity, 6000);
});
