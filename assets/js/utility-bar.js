document.addEventListener('DOMContentLoaded', () => {
  /* ---------- DATA ---------- */

  /* 6 rotating cities; oblastId matches SVG ids in assets/svg/ukraine-map.svg */
  const cities = [
    { city: "Kyiv", temp: "3Â°C", weather: "â˜ï¸ Cloudy", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/kyiv.jpg", oblastId: "KyivCity" },
    { city: "Lviv", temp: "-1Â°C", weather: "â„ï¸ Snow", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/lviv.jpg", oblastId: "Lviv" },
    { city: "Kharkiv", temp: "0Â°C", weather: "ðŸŒ«ï¸ Fog", alert: "ðŸ”´ Critical", photo: "/assets/images/cities/kharkiv.jpg", oblastId: "Kharkiv" },
    { city: "Odesa", temp: "4Â°C", weather: "ðŸŒ§ï¸ Rain", alert: "ðŸŸ  High Risk", photo: "/assets/images/cities/odesa.jpg", oblastId: "Odessa" },
    { city: "Mykolaiv", temp: "2Â°C", weather: "â˜ï¸ Cloudy", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/mykolaiv.jpg", oblastId: "Mykolaiv" },
    { city: "Zaporizhzhia", temp: "1Â°C", weather: "ðŸŒ¤ï¸ Partly Cloudy", alert: "ðŸŸ¡ Elevated Risk", photo: "/assets/images/cities/zaporizhzhia.jpg", oblastId: "Zaporizhia" }
  ];

  /* All 24 oblasts + Kyiv + Sevastopol/Crimea, grouped North / South / East / West. 6 cities rotate across 4 rows. */
  const REGIONS = {
    north: {
      label: "North",
      oblastIds: ["Chernihiv", "Kiev", "KyivCity", "Poltava", "Sumu", "Zhytomyr"],
      cityIndices: [0]
    },
    south: {
      label: "South",
      oblastIds: ["Crimea", "Kherson", "Mykolaiv", "Odessa", "SevastopolCity"],
      cityIndices: [3, 4]
    },
    east: {
      label: "East",
      oblastIds: ["Dnipropetrovsk", "Donetsk", "Kharkiv", "Luhansk", "Zaporizhia"],
      cityIndices: [2, 5]
    },
    west: {
      label: "West",
      oblastIds: ["Cherkasy", "Chernivtsi", "Ivano-Frankivsk", "Khmelnytskyi", "Kirovohrad", "Lviv", "Rivne", "Ternopil", "Vinnytsia", "Volyn", "Zakarpattia"],
      cityIndices: [1]
    }
  };

  /* Daily autogenerated fact about Ukraine â€” one per day of year (index 0â€“365) */
  const ukraineFacts = [
    "Ukraine is home to the worldâ€™s deepest metro station (Arsenalna, Kyiv).",
    "Ukraine has seven UNESCO World Heritage sites, including Kyivâ€™s Saint-Sophia Cathedral.",
    "The Ukrainian language is one of the most widely spoken Slavic languages.",
    "Ukraine is often called the â€œbreadbasket of Europeâ€ for its grain production.",
    "Lvivâ€™s historic centre is a UNESCO World Heritage site.",
    "Ukraineâ€™s Carpathian Mountains are a key biodiversity hotspot.",
    "The country has a long tradition of folk embroidery, with regional patterns.",
    "Ukraineâ€™s constitution was adopted in 1996.",
    "Odesa is known for its architecture and the Potemkin Stairs.",
    "Ukrainian literature includes Taras Shevchenko and Lesya Ukrainka.",
    "Ukraine has a strong tradition of choral and bandura music.",
    "The Trypillian culture in Ukraine dates back over 6,000 years.",
    "Ukraineâ€™s Dnipro River is one of the major rivers of Europe.",
    "Kyivâ€™s Golden Gate is a historic gateway from the medieval city.",
    "Ukraine has contributed significantly to aerospace and IT industries.",
    "The pysanka (decorated egg) is a symbol of Ukrainian culture.",
    "The country has 24 oblasts plus Kyiv and Sevastopol.",
    "Ukrainian diaspora communities exist across the Americas and Europe.",
    "Ukraineâ€™s nature reserves protect rare species like the European bison.",
    "The sunflower is an important national symbol.",
    "Ukraineâ€™s IT sector has grown into a major export industry.",
    "Traditional Ukrainian cuisine includes borscht, varenyky, and salo.",
    "Ukraineâ€™s flag combines blue (sky) and yellow (wheat).",
    "The Hryvnia is Ukraineâ€™s currency.",
    "Ukrainian civil society has shown remarkable resilience.",
    "Ukraineâ€™s Black Sea coast has important ports and ecosystems.",
    "Ukrainian volunteers have been central to humanitarian response.",
    "The countryâ€™s museums preserve art, history, and cultural heritage.",
    "Ukraineâ€™s healthcare and education systems have deep historical roots.",
    "Ukrainian designers and craftspeople preserve traditional arts.",
    "The countryâ€™s legal profession supports justice and accountability.",
    "Ukraineâ€™s women have been leaders in military, medicine, and civil society.",
    "Ukrainian musicians perform classical, folk, and contemporary music.",
    "The countryâ€™s architects plan reconstruction of cities and villages.",
    "Ukraineâ€™s teachers continue to educate in shelters and online.",
    "Ukrainian poets and writers reflect on identity and resistance.",
    "The countryâ€™s engineers work on demining and reconstruction.",
    "Ukraineâ€™s farmers have continued to plant and harvest under difficult conditions.",
    "Ukrainian filmmakers document the war and recovery.",
    "The countryâ€™s psychologists support trauma recovery.",
    "Ukraineâ€™s hospitals and clinics provide care under fire.",
    "Ukrainian translators bridge languages for aid and diplomacy.",
    "The countryâ€™s mayors and local leaders coordinate recovery.",
    "Ukraineâ€™s culture of mutual aid strengthens communities.",
    "Ukrainian runners and cyclists raise funds for aid.",
    "The countryâ€™s firefighters and rescuers save lives daily.",
    "Ukraineâ€™s youth have driven innovation and civic engagement.",
    "Ukrainian artists document and respond to the war through art.",
    "The countryâ€™s libraries and archives preserve written heritage.",
    "Ukraineâ€™s railways help evacuate people and deliver aid.",
    "Ukrainian chefs and restaurants keep culinary traditions alive.",
    "The countryâ€™s NGOs coordinate with international aid agencies."
  ];

  /* Humanitarian/aid Ukraine news: loaded from assets/data/ukraine-news.json (EN + UK, rotates). Fallback below. */
  const newsSnippetsFallback = [
    { title_en: "Local NGOs deliver heating equipment to families in Lviv oblast.", title_uk: "ÐœÑ–ÑÑ†ÐµÐ²Ñ– ÐÐ£Ðž Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽÑ‚ÑŒ Ð¾Ð¿Ð°Ð»ÑŽÐ²Ð°Ð»ÑŒÐ½Ðµ Ð¾Ð±Ð»Ð°Ð´Ð½Ð°Ð½Ð½Ñ ÑÑ–Ð¼'ÑÐ¼ Ñƒ Ð›ÑŒÐ²Ñ–Ð²ÑÑŒÐºÑ–Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ñ–.", url: "/programs/humanitarian", category: "humanitarian" },
    { title_en: "Ukrainian volunteers run community kitchens in Odesa.", title_uk: "Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÑ– Ð²Ð¾Ð»Ð¾Ð½Ñ‚ÐµÑ€Ð¸ Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð¾Ð²ÑƒÑŽÑ‚ÑŒ Ð³Ñ€Ð¾Ð¼Ð°Ð´ÑÑŒÐºÑ– ÐºÑƒÑ…Ð½Ñ– Ð² ÐžÐ´ÐµÑÑ–.", url: "/programs/humanitarian", category: "civil-society" },
    { title_en: "Mental health support expands for displaced children in Kyiv region.", title_uk: "Ð Ð¾Ð·ÑˆÐ¸Ñ€ÑŽÑ”Ñ‚ÑŒÑÑ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ñ–Ñ‡Ð½Ð¾Ð³Ð¾ Ð·Ð´Ð¾Ñ€Ð¾Ð²'Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼Ñ–Ñ‰ÐµÐ½Ð¸Ñ… Ð´Ñ–Ñ‚ÐµÐ¹ Ñƒ ÐšÐ¸Ñ—Ð²ÑÑŒÐºÐ¾Ð¼Ñƒ Ñ€ÐµÐ³Ñ–Ð¾Ð½Ñ–.", url: "/programs/resilience", category: "humanitarian" }
  ];

  /* ---------- ELEMENTS ---------- */

  const rotationCta = document.getElementById('rotation-cta');
  const factOfDayEl = document.getElementById('fact-of-day');
  const newsSnippetEl = document.getElementById('news-snippet');
  const mapTooltip = document.getElementById('map-tooltip');
  const timeKyivEl = document.getElementById('time-kyiv');
  const timeBremertonEl = document.getElementById('time-bremerton');
  const mapContainer = document.getElementById('utility-map-container');
  let oblastEls = [];

  /* ---------- LIVE CLOCKS: Kyiv (Europe/Kyiv), Bremerton (America/Los_Angeles) ---------- */

  const timeOpts = { hour: '2-digit', minute: '2-digit', hour12: false };

  function updateClocks() {
    const now = new Date();
    const kyivTime = now.toLocaleTimeString('en-GB', { ...timeOpts, timeZone: 'Europe/Kyiv' });
    const bremertonTime = now.toLocaleTimeString('en-GB', { ...timeOpts, timeZone: 'America/Los_Angeles' });
    if (timeKyivEl) {
      timeKyivEl.textContent = kyivTime;
      timeKyivEl.setAttribute('datetime', now.toISOString());
    }
    if (timeBremertonEl) {
      timeBremertonEl.textContent = bremertonTime;
      timeBremertonEl.setAttribute('datetime', now.toISOString());
    }
  }

  updateClocks();
  setInterval(updateClocks, 1000);

  /* ---------- FOUR ROWS (North/South/East/West) + 6 CITIES ROTATE + MAP HIGHLIGHT ---------- */

  let southIndex = 0;
  let eastIndex = 0;

  function setActiveOblasts(oblastIds) {
    oblastEls.forEach(o => o.classList.remove('oblast-active'));
    if (!Array.isArray(oblastIds)) oblastIds = [oblastIds];
    oblastIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('oblast-active');
    });
  }

  function getCityForRegion(regionKey) {
    const r = REGIONS[regionKey];
    if (!r || !r.cityIndices.length) return null;
    const idx = regionKey === "south" ? southIndex : regionKey === "east" ? eastIndex : 0;
    const cityIndex = r.cityIndices[idx % r.cityIndices.length];
    return cities[cityIndex];
  }

  function updateRegionRows() {
    ["north", "south", "east", "west"].forEach(regionKey => {
      const city = getCityForRegion(regionKey);
      const photoEl = document.querySelector(`.region-photo[data-region="${regionKey}"]`);
      const textEl = document.querySelector(`.region-text[data-region="${regionKey}"]`);
      if (photoEl && textEl && city) {
        photoEl.src = city.photo;
        photoEl.alt = city.city + " photo";
        textEl.textContent = `${city.city} â€” ${city.temp} â€¢ ${city.weather} â€¢ ${city.alert}`;
      }
    });
    const ids = ["north", "south", "east", "west"].map(k => getCityForRegion(k)).filter(Boolean).map(c => c.oblastId);
    setActiveOblasts(ids);
  }

  function rotateRegionCity() {
    southIndex = (southIndex + 1) % Math.max(1, REGIONS.south.cityIndices.length);
    eastIndex = (eastIndex + 1) % Math.max(1, REGIONS.east.cityIndices.length);
    updateRegionRows();
  }

  function findRegionByOblastId(oblastId) {
    for (const key of Object.keys(REGIONS)) {
      if (REGIONS[key].oblastIds.includes(oblastId)) return key;
    }
    return null;
  }

  function setRegionToCity(regionKey, city) {
    const r = REGIONS[regionKey];
    if (!r || !r.cityIndices.length) return;
    const i = cities.findIndex(c => c.oblastId === city.oblastId);
    if (i === -1) return;
    const pos = r.cityIndices.indexOf(i);
    if (pos === -1) return;
    if (regionKey === "south") southIndex = pos;
    if (regionKey === "east") eastIndex = pos;
    updateRegionRows();
  }

  /* ---------- CTA (single; optional rotation of link) ---------- */

  const ctaLinks = [
    { text: "How You Can Help Today", href: "/donate" },
    { text: "Donate to Humanitarian Aid", href: "/donate" },
    { text: "Support Legal Research", href: "/programs/legal-research" },
    { text: "Volunteer with WSUA", href: "/volunteer-apply" }
  ];
  let ctaIndex = 0;
  function rotateCta() {
    if (!rotationCta) return;
    const cta = ctaLinks[ctaIndex];
    rotationCta.textContent = cta.text;
    rotationCta.href = cta.href;
    ctaIndex = (ctaIndex + 1) % ctaLinks.length;
  }
  rotateCta();
  setInterval(rotateCta, 8000);

  /* ---------- DAILY FACT (autogenerated by day of year) ---------- */

  function getFactOfDay() {
    const start = new Date(new Date().getFullYear(), 0, 0);
    const now = new Date();
    const dayOfYear = Math.floor((now - start) / (1000 * 60 * 60 * 24));
    const index = dayOfYear % ukraineFacts.length;
    return ukraineFacts[index];
  }

  function renderFactOfDay() {
    if (!factOfDayEl) return;
    const fact = getFactOfDay();
    factOfDayEl.innerHTML = `<span class="fact-label">Fact of the day:</span> ${fact} <a href="/about">Learn more â†’</a>`;
  }

  /* ---------- NEWS SNIPPET: fetch real feed, rotate EN â†” UK ---------- */

  let newsItems = [];
  let newsIndex = 0;
  let showUkrainian = false;

  function renderNewsSnippet() {
    if (!newsSnippetEl) return;
    if (newsItems.length === 0) {
      newsSnippetEl.innerHTML = `<span class="news-label">Ukraine:</span> <a href="/programs/humanitarian">Loading newsâ€¦</a>`;
      return;
    }
    const item = newsItems[newsIndex];
    const title = showUkrainian ? (item.title_uk || item.title_en) : (item.title_en || item.title_uk);
    const lang = showUkrainian ? 'uk' : 'en';
    newsSnippetEl.innerHTML = `<span class="news-label">Ukraine:</span> <a href="${item.url}" target="_blank" rel="noopener" hreflang="${lang}">${escapeHtml(title)}</a>`;
    showUkrainian = !showUkrainian;
    if (!showUkrainian) newsIndex = (newsIndex + 1) % newsItems.length;
  }

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  renderNewsSnippet();
  fetch('/assets/data/ukraine-news.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      if (data && Array.isArray(data.items) && data.items.length > 0) {
        newsItems = data.items;
      } else {
        newsItems = newsSnippetsFallback;
      }
      renderNewsSnippet();
    })
    .catch(() => {
      newsItems = newsSnippetsFallback;
      renderNewsSnippet();
    })
    .finally(() => {
      setInterval(renderNewsSnippet, 8000);
    });

  /* ---------- MAP: load SVG from file and init click + tooltip ---------- */

  function initMap() {
    oblastEls = document.querySelectorAll('#utility-map-container .oblast');
    if (oblastEls.length) {
      oblastEls.forEach(oblast => {
        oblast.addEventListener('click', (e) => {
          const id = oblast.id || oblast.dataset.region;
          if (!id) return;
          e.preventDefault();
          const city = cities.find(c => c.oblastId === id);
          if (city) {
            const regionKey = findRegionByOblastId(id);
            if (regionKey) setRegionToCity(regionKey, city);
          } else {
            window.location.href = '/programs/humanitarian';
          }
        });

        oblast.addEventListener('mousemove', (e) => {
          const name = oblast.dataset.name || oblast.id || "Ukraine Region";
          mapTooltip.textContent = name;
          mapTooltip.style.left = e.clientX + "px";
          mapTooltip.style.top = e.clientY + "px";
          mapTooltip.style.opacity = "1";
        });

        oblast.addEventListener('mouseleave', () => {
          mapTooltip.style.opacity = "0";
        });
      });
    }
    updateRegionRows();
  }

  if (mapContainer) {
    fetch('/assets/svg/ukraine-map.svg')
      .then(r => r.ok ? r.text() : Promise.reject(new Error('Map load failed')))
      .then(svgText => {
        const wrap = document.createElement('div');
        wrap.innerHTML = svgText.trim();
        const svg = wrap.firstElementChild;
        if (svg) {
          svg.classList.add('ukraine-map');
          svg.setAttribute('aria-label', svg.getAttribute('aria-label') || 'Map of Ukraine');
          const placeholder = mapContainer.querySelector('.utility-map-placeholder');
          if (placeholder) placeholder.remove();
          mapContainer.insertBefore(svg, mapContainer.firstChild);
          /* CodePen map: each <a id="..."> is an oblast; add class oblast and data attributes */
          const links = mapContainer.querySelectorAll('#Ukraine a[id], #ukraineMap a[id]');
          links.forEach(a => {
            a.classList.add('oblast');
            a.removeAttribute('href');
            a.removeAttribute('target');
            const id = a.getAttribute('id') || '';
            a.setAttribute('data-region', id.replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, ''));
            a.setAttribute('data-name', id.replace(/([A-Z])/g, ' $1').trim() + ' Oblast');
          });
          initMap();
        }
      })
      .catch(() => { /* leave placeholder visible */ });
  }

  /* ---------- MOBILE: collapse bar on scroll, tap to expand ---------- */

  const utilityWrapper = document.querySelector('.utility-header-wrapper');
  if (utilityWrapper) {
    function updateCollapsed() {
      const isMobile = window.innerWidth <= 768;
      const scrolled = window.scrollY > 80;
      if (isMobile && scrolled) {
        utilityWrapper.classList.add('utility-bar-collapsed');
      } else {
        utilityWrapper.classList.remove('utility-bar-collapsed');
      }
    }
    window.addEventListener('scroll', updateCollapsed, { passive: true });
    window.addEventListener('resize', updateCollapsed);
    updateCollapsed();

    utilityWrapper.addEventListener('click', (e) => {
      if (e.target.closest('a, button')) return; /* let links/buttons work */
      if (utilityWrapper.classList.contains('utility-bar-collapsed')) {
        utilityWrapper.classList.remove('utility-bar-collapsed');
      }
    });
  }

  /* ---------- INIT ---------- */

  updateRegionRows();
  renderFactOfDay();

  setInterval(rotateRegionCity, 6000);
});
